<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.timeSync.www.mapper.TbUserMapper">
  <update id="updateImg">
    update tb_user set photo=#{url} where id=#{userId}
  </update>
  <select id="havaRootUser" resultType="boolean">
    select if(count(*), true, false)
    from tb_user
    where root = 1
  </select>

  <select id="searchIdByOpenId" parameterType="String" resultType="integer">
    select id from tb_user where open_id=#{openId} and status=1
  </select>

  <select id="searchUserPermissions" parameterType="int" resultType="String">
    select DISTINCT p.permission_name
    from tb_user u
    join tb_role r on json_contains(u.role, cast(r.id as char))
    join tb_permission p on json_contains(r.permissions, cast(p.id as char))
    WHERE u.id = #{userId} and u.status = 1
  </select>
  <select id="searchById" resultType="com.timeSync.www.entity.TbUser">
    SELECT id, open_id, nickname, photo, name, sex, tel, role, root, dept_id, status, create_time
    FROM tb_user
    WHERE id = #{userId}
      AND status = 1
  </select>

  <insert id="insert" parameterType="hashmap">
    insert into tb_user
    set
    <if test="openId!=null">
      open_id=#{openId},
    </if>
    <if test="nickname!=null">
      nickname=#{nickname},
    </if>
    <if test="photo!=null">
      photo=#{photo},
    </if>
    <if test="name!=null">
      name=#{name},
    </if>
    <if test="sex!=null">
      sex=#{sex},
    </if>
    <if test="tel!=null">
      tel=#{tel},
    </if>
    <if test="email!=null">
      email=#{email},
    </if>
    <if test="hiredate!=null">
      hiredate=#{hiredate},
    </if>
    role=#{role},
    root=#{root},
    <if test="deptName!=null">
      dept_id=(select id from tb_dept where dept_name=#{deptName}),
    </if>
    status=#{status},
    create_time=#{createTime}
  </insert>



</mapper>
